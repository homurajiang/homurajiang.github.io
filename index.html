<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>羽毛球对阵生成工具</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        :root { --primary-color: #007bff; --secondary-color: #6c757d; --bg-color: #f8f9fa; --font-color: #333; --border-color: #dee2e6; --card-bg: #fff; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; margin: 0; background-color: var(--bg-color); color: var(--font-color); }
        .container { max-width: 700px; margin: 2em auto; padding: 2em; background-color: var(--card-bg); border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        h1, h2 { text-align: center; color: var(--primary-color); }
        h2 { color: var(--secondary-color); border-bottom: 1px solid var(--border-color); padding-bottom: 10px; margin-top: 2em; }
        .player-row { display: flex; align-items: center; margin-bottom: 10px; padding: 10px; border: 1px solid var(--border-color); border-radius: 5px; }
        .player-row input[type="text"] { flex-grow: 1; margin-right: 10px; padding: 8px; border: 1px solid var(--border-color); border-radius: 4px; }
        .gender-group { margin-right: 10px; }
        .actions { margin-top: 15px; display: flex; gap: 10px; }
        button, input[type="submit"] { cursor: pointer; padding: 10px 15px; border: none; border-radius: 5px; font-size: 16px; font-weight: 500; }
        button[type="button"], #add-player, #clear-players { background-color: var(--secondary-color); color: white; }
        button[type="submit"], .submit-btn { background-color: var(--primary-color); color: white; width: 100%; margin-top: 1em; }
        button:hover, input[type="submit"]:hover { opacity: 0.9; }
        .form-group { margin: 20px 0; }
        select, input[type="radio"] { margin-right: 5px; }
        label { margin-right: 15px; }
        .history-section { margin-top: 3em; }
        #history-list { list-style: none; padding: 0; }
        #history-list li { background-color: #f0f0f0; margin-bottom: 8px; border-radius: 5px; transition: background-color 0.2s; }
        #history-list li a { display: block; padding: 12px 15px; text-decoration: none; color: var(--font-color); cursor: pointer; }
        #history-list li:hover { background-color: #e0e0e0; }
    </style>
</head>
<body>
    <div class="container">
        <h1>羽毛球对阵生成工具</h1>
        <form id="main-form">
            <h2>队员列表</h2>
            <div id="players-list"></div>
            <div class="actions">
                <button type="button" id="add-player">添加队员</button>
                <button type="button" id="clear-players">清空列表</button>
            </div>
            <div class="form-group">
                <h2>模式选择</h2>
                <input type="radio" id="random_doubles" name="mode" value="random_doubles" checked>
                <label for="random_doubles">随机双打</label>
                <input type="radio" id="mixed" name="mode" value="mixed">
                <label for="mixed">男女混双</label>
                <input type="radio" id="singles_robin" name="mode" value="singles_robin">
                <label for="singles_robin">单打轮转</label>
            </div>
            <div class="form-group">
                <h2>每人对局数</h2>
                <select name="k" id="k-select" required style="padding: 8px; border-radius: 4px;"></select>
            </div>
            <button type="submit" class="submit-btn">生成对阵</button>
        </form>
        <div class="history-section">
            <h2>历史记录 (保存在您的浏览器中)</h2>
            <ul id="history-list"></ul>
        </div>
    </div>

    <script>
        // 重要：部署后请将此URL替换为您的Vercel后端地址
        const API_BASE_URL = 'https://homurajiang-github-io.vercel.app';

        const playersList = document.getElementById('players-list');
        const addPlayerBtn = document.getElementById('add-player');
        const clearPlayersBtn = document.getElementById('clear-players');
        const kSelect = document.getElementById('k-select');
        const modeRadios = document.querySelectorAll('input[name="mode"]');
        const mainForm = document.getElementById('main-form');
        const historyList = document.getElementById('history-list');
        let playerCount = 0;

        const DB_KEYS = { PLAYERS: 'badminton_players', HISTORY: 'badminton_history' };

        function savePlayers() {
            localStorage.setItem(DB_KEYS.PLAYERS, JSON.stringify(getPlayersData()));
        }

        function loadPlayers() {
            const saved = localStorage.getItem(DBKEYS.PLAYERS);
            if (saved) {
                const players = JSON.parse(saved);
                if (players && players.length > 0) {
                    players.forEach(p => addPlayer(p.name, p.gender));
                    return;
                }
            }
            for (let i = 0; i < 6; i++) addPlayer();
        }

        function createPlayerRow(id, name = '', gender = 'M') {
            const div = document.createElement('div');
            div.className = 'player-row';
            div.id = `player-row-${id}`;
            div.innerHTML = `
                <input type="text" placeholder="队员姓名" value="${name}" required>
                <span class="gender-group">
                    <input type="radio" id="gender-m-${id}" name="player-gender-${id}" value="M" ${gender === 'M' ? 'checked' : ''}> <label for="gender-m-${id}">男</label>
                    <input type="radio" id="gender-f-${id}" name="player-gender-${id}" value="F" ${gender === 'F' ? 'checked' : ''}> <label for="gender-f-${id}">女</label>
                </span>
                <button type="button" class="remove-player-btn">删除</button>`;
            return div;
        }

        function addPlayer(name = '', gender = 'M') {
            const newRow = createPlayerRow(playerCount, name, gender);
            playersList.appendChild(newRow);
            playerCount++;
            updateKOptions();
        }

        function getPlayersData() {
            const players = [];
            playersList.querySelectorAll('.player-row').forEach(row => {
                const nameInput = row.querySelector('input[type="text"]');
                const genderInput = row.querySelector('input[type="radio"]:checked');
                if (nameInput && nameInput.value && genderInput) {
                    players.push({ name: nameInput.value, gender: genderInput.value });
                }
            });
            return players;
        }

        async function updateKOptions() {
            const players = getPlayersData();
            if (players.length < 4) {
                kSelect.innerHTML = '<option>队员不足</option>';
                return;
            }
            const mode = document.querySelector('input[name="mode"]:checked').value;
            try {
                const response = await fetch(`${API_BASE_URL}/api/get_k_options`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ players, mode })
                });
                const options = await response.json();
                kSelect.innerHTML = '';
                if (options.length > 0) {
                    options.forEach(k => kSelect.innerHTML += `<option value="${k}">${k}</option>`);
                } else {
                    kSelect.innerHTML = '<option>无可用局数</option>';
                }
            } catch (e) {
                kSelect.innerHTML = '<option>无法连接后端</option>';
            }
        }

        function loadHistory() {
            const history = JSON.parse(localStorage.getItem(DB_KEYS.HISTORY) || '[]');
            history.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
            historyList.innerHTML = '';
            if (history.length === 0) {
                historyList.innerHTML = '<li>暂无历史记录</li>';
                return;
            }
            history.forEach(item => {
                const title = `${new Date(item.timestamp).toLocaleString()} - ${item.players.length}人局`;
                historyList.innerHTML += `<li><a data-history-id="${item.id}">${title}</a></li>`;
            });
        }

        historyList.addEventListener('click', e => {
            if (e.target.tagName === 'A') {
                const historyId = e.target.dataset.historyId;
                const history = JSON.parse(localStorage.getItem(DB_KEYS.HISTORY) || '[]');
                const data = history.find(item => item.id === historyId);
                if (data) {
                    sessionStorage.setItem('current_match_data', JSON.stringify(data));
                    window.location.href = 'result.html';
                }
            }
        });

        mainForm.addEventListener('submit', async e => {
            e.preventDefault();
            const submitBtn = e.target.querySelector('button[type="submit"]');
            submitBtn.textContent = '生成中...';
            submitBtn.disabled = true;
            const players = getPlayersData();
            const mode = document.querySelector('input[name="mode"]:checked').value;
            const k = parseInt(kSelect.value, 10);
            try {
                const response = await fetch(`${API_BASE_URL}/api/generate`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ players, mode, k })
                });
                if (!response.ok) {
                    const err = await response.json();
                    throw new Error(err.error || '生成失败');
                }
                const data = await response.json();
                sessionStorage.setItem('current_match_data', JSON.stringify(data));
                window.location.href = 'result.html';
            } catch (error) {
                alert(`错误: ${error.message}`);
            } finally {
                submitBtn.textContent = '生成对阵';
                submitBtn.disabled = false;
            }
        });

        playersList.addEventListener('click', e => {
            if (e.target.classList.contains('remove-player-btn')) {
                e.target.closest('.player-row').remove();
                savePlayers();
                updateKOptions();
            }
        });
        addPlayerBtn.addEventListener('click', () => addPlayer());
        clearPlayersBtn.addEventListener('click', () => {
            playersList.innerHTML = '';
            playerCount = 0;
            localStorage.removeItem(DB_KEYS.PLAYERS);
            for (let i = 0; i < 6; i++) addPlayer();
            savePlayers();
        });
        playersList.addEventListener('input', () => { savePlayers(); updateKOptions(); });
        modeRadios.forEach(radio => radio.addEventListener('change', updateKOptions));

        loadPlayers();
        loadHistory();
    </script>
</body>
</html>